{% extends "bootstrap/base.html" %}
{% block title %}Gallery{% endblock %}

{% block navbar %}
<div class="navbar">
    <span class="pull-right"><a class="btn btn-sm btn-default" style="margin: 10px"
                                href="/manage">Manage gallery</a></span>
    <h3 style="display: block; max-width: 200px">Wedding Gallery</h3>
</div>
{% endblock %}

{% block content %}
<section class="container">
    <h1>Photos:</h1>
    <p>
        sort by: <a href="/?page={{ request.args.get('page', 1) }}&sort=likes">likes</a> | <a
            href="/?page={{ request.args.get('page', 1) }}&sort=timestamp">date</a>
    </p>
    {% if photos['totalItems'] > 0 %}
    <div class="row text-center text-lg-left">
        {% for photo in photos['items'] %}
        <div class="col-lg-3 col-md-4 col-6">
            <a href="{{photo.url}}" class="d-block mb-4 h-100">
                <img class="img-fluid img-thumbnail" src="{{photo.url}}" alt="" title="Download">
            </a>
            <p class="text-center">Author: {{photo.author}}</p>
            <span><span id="{{photo._id}}">{{photo.likes}}</span><button onclick="like('{{photo._id}}')"
                                                                         class="btn btn-link"><i
                    class="glyphicon glyphicon-thumbs-up"></i></button></span>
        </div>
        {% endfor %}
    </div>
    <div class="container text-center">
        <span class="text-sm">page {{photos['page']}} de {{photos['totalPages']}}</span>
        {% if photos['hasPrev'] %}
        <a href="/?page={{ photos['page']-1 }}&sort={{request.args.get('sort', 'likes')}}"><< prev</a>
        {% endif %}

        {% if photos['hasNext'] %}
        <a href="/?page={{ photos['page']+1 }}&sort={{request.args.get('sort', 'likes')}}">next >></a>
        {% endif %}
    </div>
    {% else %}
    <div class="center-block"><h4>No photos was uploaded.</h4></div>
    {% endif %}
</section>
<hr/>
<section class="container">
    <h2>Select a photo to upload</h2>
    <p>
        {% with messages = get_flashed_messages() %}
        {% if messages %}
    <ul class=flashes>
        {% for message in messages %}
        <li>{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    {% endwith %}
    </p>
    <form method="post" action="/upload" enctype="multipart/form-data">
        <dl>
            <p>
                <input type="file" name="file" autocomplete="off" required>
            </p>
        </dl>
        <dl>
            <p>
                <input type="text" name="author" placeholder="Author" autocomplete="off" required>
            </p>
        </dl>
        <p>
            <input type="submit" value="Submit">
        </p>
    </form>
</section>
{% endblock %}
{% block scripts %}
{{ super() }}

<script>
    function like(photo_id) {
        let likes_value = $("#" + photo_id);
        let n_likes = likes_value.html();
        likes_value.html(parseInt(n_likes) + 1);
        $.post("/api/photos/" + photo_id + "/like", function (data) {
            let response = JSON.parse(data);
            if (response.success && n_likes < response.total_likes) {
                $("#" + photo_id).html(response.total_likes);
            }
        });
    }
</script>
{% endblock %}